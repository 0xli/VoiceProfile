<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VoiceProfile</title>
</head>
<body>
<h1><img src="logo.webp">Upload a Voice File</h1>
<form action="/upload" method="post" enctype="multipart/form-data">
    <input type="file" name="voiceFile" accept="audio/*" required>
    <button type="submit">Upload</button>
</form>

<h2>Record Your Voice</h2>
<button id="recordButton">Start Recording</button>
<button id="stopButton" disabled>Stop Recording</button>
<audio id="recordedAudio" controls></audio>

<h2>Explore Voice Files</h2>
<div id="fileList"></div>
<div id="genderResult"></div>

<script>
    let mediaRecorder;
    let audioChunks = [];

    document.getElementById('recordButton').addEventListener('click', async () => {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream);
        mediaRecorder.start();

        mediaRecorder.addEventListener('dataavailable', event => {
            audioChunks.push(event.data);
        });

        mediaRecorder.addEventListener('stop', () => {
            const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
            const audioUrl = URL.createObjectURL(audioBlob);
            document.getElementById('recordedAudio').src = audioUrl;

            // Upload the recorded audio
            const formData = new FormData();
            formData.append('voiceFile', audioBlob, 'recorded_audio.wav');
            fetch('/upload', {
                method: 'POST',
                body: formData
            }).then(() => {
                loadFiles();
            });
        });

        document.getElementById('recordButton').disabled = true;
        document.getElementById('stopButton').disabled = false;
    });

    document.getElementById('stopButton').addEventListener('click', () => {
        mediaRecorder.stop();
        document.getElementById('recordButton').disabled = false;
        document.getElementById('stopButton').disabled = true;
    });

    async function loadFiles() {
        const response = await fetch('/files');
        const files = await response.json();
        const fileListDiv = document.getElementById('fileList');
        fileListDiv.innerHTML = '';
        files.forEach(file => {
            const audioElement = document.createElement('audio');
            audioElement.controls = true;
            audioElement.src = `/uploads/${file}`;
            const fileName = document.createElement('p');
            fileName.textContent = file;
            fileListDiv.appendChild(fileName);
            fileListDiv.appendChild(audioElement);
        });

        // Show detected gender if available
        const urlParams = new URLSearchParams(window.location.search);
        const gender = urlParams.get('gender');
        if (gender) {
            const genderResultDiv = document.getElementById('genderResult');
            genderResultDiv.innerHTML = '';
            if (gender !== 'Error') {
                const genderElement = document.createElement('p');
                genderElement.textContent = `Gender detected: ${gender}`;
                genderResultDiv.appendChild(genderElement);
            } else {
                const errorElement = document.createElement('p');
                errorElement.textContent = 'Error detecting gender. Please try again.';
                genderResultDiv.appendChild(errorElement);
            }
        }
    }

    // Load files when the page loads
    window.onload = loadFiles;
</script>
</body>
</html>
